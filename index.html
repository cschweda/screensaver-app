<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Screensaver</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif; /* Use Inter font */
            overscroll-behavior: none; /* Prevent pull-to-refresh */
        }

        /* Ensure fullscreen element covers everything */
        #fullscreen-container:-webkit-full-screen {
            width: 100%;
            height: 100%;
            background-color: var(--bg-color, #2e2e2e); /* 18% grey */
        }
        #fullscreen-container:fullscreen {
            width: 100%;
            height: 100%;
            background-color: var(--bg-color, #2e2e2e); /* 18% grey */
        }

        /* Style for the image display */
        #image-display {
            max-width: 95vw; /* Use viewport width to ensure it fits on all screens */
            max-height: 85vh; /* Limit height to leave space for title and info */
            width: auto;
            height: auto;
            object-fit: contain; /* Scale image while preserving aspect ratio */
            display: block; /* Remove extra space below image */
            margin: 0 auto; /* Center horizontally */
            position: relative; /* Ensure proper stacking */
        }

        /* Corner hover zones */
        .corner-zone {
            position: absolute;
            width: 80px; /* Increased size for easier hover */
            height: 80px; /* Increased size for easier hover */
            /* background-color: rgba(255, 0, 0, 0.1); */ /* Uncomment for debugging */
            z-index: 100; /* Ensure they are above the image */
        }
        #top-left-zone { top: 0; left: 0; }
        #top-right-zone { top: 0; right: 0; }
        #bottom-left-zone { bottom: 0; left: 0; }
        #bottom-right-zone { bottom: 0; right: 0; }

        /* Corner menu */
        #corner-menu {
            position: absolute;
            top: 10px;
            left: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1rem; /* p-4 */
            z-index: 110; /* Above corner zones */
            display: none; /* Hidden by default */
            color: white;
        }

        /* Hide controls when in fullscreen */
        #fullscreen-container:fullscreen #controls-container {
            display: none;
        }
         /* Show fullscreen elements only when in fullscreen */
        #fullscreen-elements {
             display: none; /* Hidden initially */
        }
         #fullscreen-container:fullscreen #fullscreen-elements {
            display: block;
            width: 100%;
            height: 100%;
            position: relative; /* Needed for absolute positioning of children */
            overflow: hidden; /* Prevent scrollbars */
         }

         /* Also handle webkit fullscreen for Safari */
         #fullscreen-container:-webkit-full-screen #fullscreen-elements {
            display: block;
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
         }

         /* Container for the image to allow for proper centering */
         #image-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10; /* Ensure it's above other elements */
         }

        /* Image transition styles */
        #image-display {
            transition: opacity 0.5s ease-in-out;
        }
        .fade-out {
            opacity: 0;
        }
        .fade-in {
            opacity: 1;
        }

        /* Ensure the image container is centered in fullscreen mode */
        #fullscreen-container:fullscreen #image-container,
        #fullscreen-container:-webkit-full-screen #image-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Crossfade transition styles */
        #image-display {
            position: relative;
            z-index: 1;
        }
        #fullscreen-elements.crossfade-active #image-display {
            opacity: 0;
        }
        #image-display-next {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 90vh;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 5; /* Ensure it's above the main image */
        }
        #fullscreen-elements.crossfade-active #image-display-next {
            opacity: 1;
        }

         /* Style for the message box */
        #message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 200;
            display: none; /* Hidden by default */
            font-size: 0.9rem;
        }

        /* Loading indicator */
        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            display: none; /* Hidden by default */
            z-index: 150;
            pointer-events: none; /* Allow clicks to pass through */
            margin: 0; /* Ensure no margins affect positioning */
        }

        @keyframes spin {
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100">

    <div id="app-container" class="container mx-auto p-4">

        <h1 class="text-2xl font-bold mb-4 text-center">Web Photo Screensaver</h1>

        <div id="controls-container" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-6">
            <div class="mb-4">
                <label for="file-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">1. Select Photos (Optional - Replaces Samples):</label>
                <input type="file" id="file-input" multiple accept="image/*" class="block w-full text-sm text-gray-500 dark:text-gray-400
                    file:mr-4 file:py-2 file:px-4
                    file:rounded-md file:border-0
                    file:text-sm file:font-semibold
                    file:bg-blue-50 dark:file:bg-blue-900 file:text-blue-700 dark:file:text-blue-300
                    hover:file:bg-blue-100 dark:hover:file:bg-blue-800
                    cursor-pointer">
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Selecting files here will override the default sample images.</p>
            </div>

            <div class="mb-4">
                <label for="duration-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">2. Display Duration (seconds):</label>
                <input type="number" id="duration-input" value="5" min="1" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700 focus:ring-blue-500 focus:border-blue-500">
            </div>

             <div class="mb-4">
                <label for="bg-color-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">3. Background Color:</label>
                <input type="color" id="bg-color-input" value="#2e2e2e" class="w-full h-10 p-1 border border-gray-300 dark:border-gray-600 rounded-md cursor-pointer">
                 <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Default is 18% grey (#2e2e2e).</p>
            </div>

            <button id="start-button" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed">
                Start Screensaver
            </button>
        </div>

        <div id="message-box"></div>

        <div id="fullscreen-container" class="relative" style="--bg-color: #2e2e2e;">
             <div id="fullscreen-elements">
                <div id="image-container">
                    <img id="image-display" src="" alt="Screensaver Image" class="fade-in">
                    <div id="loading-indicator"></div>
                </div>
                <div id="image-info" class="text-center text-white text-sm absolute bottom-4 left-0 right-0 bg-black bg-opacity-50 p-2 rounded">
                </div>

                <div id="top-left-zone" class="corner-zone"></div>
                <div id="top-right-zone" class="corner-zone"></div>
                <div id="bottom-left-zone" class="corner-zone"></div>
                <div id="bottom-right-zone" class="corner-zone"></div>

                <div id="corner-menu">
                    <h3 class="text-lg font-semibold mb-2">Menu</h3>
                    <button id="restart-button" class="block w-full text-left px-3 py-1 mb-1 rounded hover:bg-gray-600 transition duration-150">Restart</button>
                    <button id="exit-button" class="block w-full text-left px-3 py-1 mb-1 rounded hover:bg-gray-600 transition duration-150">Exit Fullscreen</button>
                    <div class="mt-3 pt-2 border-t border-gray-600">
                        <h4 class="text-sm font-semibold mb-1">Keyboard Shortcuts:</h4>
                        <div class="text-xs text-gray-300">
                            <div class="mb-1">→ or Space: Next image</div>
                            <div class="mb-1">←: Previous image</div>
                            <div class="mb-1">M: Toggle menu</div>
                            <div>Esc: Exit fullscreen</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const fileInput = document.getElementById('file-input');
        const durationInput = document.getElementById('duration-input');
        const startButton = document.getElementById('start-button');
        const fullscreenContainer = document.getElementById('fullscreen-container');
        const imageDisplay = document.getElementById('image-display');
        const imageInfo = document.getElementById('image-info');
        const cornerMenu = document.getElementById('corner-menu');
        const exitButton = document.getElementById('exit-button');
        const restartButton = document.getElementById('restart-button');
        const cornerZones = document.querySelectorAll('.corner-zone');
        const bgColorInput = document.getElementById('bg-color-input');
        const messageBox = document.getElementById('message-box');
        const fullscreenElements = document.getElementById('fullscreen-elements');
        const loadingIndicator = document.getElementById('loading-indicator');

        // --- Sample Images Data ---
        const sampleImages = [
            { url: 'https://placehold.co/1920x1080/A52A2A/ffffff?text=Wide+Landscape+1', name: 'Sample Wide Landscape 1' },
            { url: 'https://placehold.co/1080x1920/2E8B57/ffffff?text=Tall+Portrait+1', name: 'Sample Tall Portrait 1' },
            { url: 'https://placehold.co/1024x768/4682B4/ffffff?text=Standard+4:3', name: 'Sample Standard 4:3' },
            { url: 'https://placehold.co/800x800/FFD700/000000?text=Square+Image', name: 'Sample Square Image' },
            { url: 'https://placehold.co/2000x800/8A2BE2/ffffff?text=Panoramic+View', name: 'Sample Panoramic View' },
            { url: 'https://placehold.co/640x480/DC143C/ffffff?text=Small+Standard', name: 'Sample Small Standard' },
            { url: 'https://placehold.co/480x640/00FFFF/000000?text=Small+Portrait', name: 'Sample Small Portrait' },
            { url: 'https://placehold.co/1600x900/FF7F50/ffffff?text=HD+16:9', name: 'Sample HD 16:9' },
            { url: 'https://placehold.co/900x1600/6495ED/ffffff?text=HD+Portrait+9:16', name: 'Sample HD Portrait 9:16' },
            { url: 'https://placehold.co/1200x600/D2691E/ffffff?text=Wide+2:1', name: 'Sample Wide 2:1' },
            { url: 'https://placehold.co/700x700/FF1493/ffffff?text=Medium+Square', name: 'Sample Medium Square' },
            { url: 'https://placehold.co/1400x1050/ADFF2F/000000?text=Large+4:3', name: 'Sample Large 4:3' },
            { url: 'https://placehold.co/1050x1400/20B2AA/ffffff?text=Large+Portrait+3:4', name: 'Sample Large Portrait 3:4' },
            { url: 'https://placehold.co/1920x1200/7FFF00/000000?text=Widescreen+16:10', name: 'Sample Widescreen 16:10' },
            { url: 'https://placehold.co/1200x1920/DB7093/ffffff?text=Tall+10:16', name: 'Sample Tall 10:16' },
            { url: 'https://placehold.co/800x600/BDB76B/000000?text=Classic+Size', name: 'Sample Classic Size' },
            { url: 'https://placehold.co/600x800/BA55D3/ffffff?text=Classic+Portrait', name: 'Sample Classic Portrait' },
            { url: 'https://placehold.co/1500x500/FF4500/ffffff?text=Very+Wide+3:1', name: 'Sample Very Wide 3:1' },
            { url: 'https://placehold.co/500x1500/1E90FF/ffffff?text=Very+Tall+1:3', name: 'Sample Very Tall 1:3' },
            { url: 'https://placehold.co/900x900/32CD32/ffffff?text=Large+Square', name: 'Sample Large Square' }
        ];

        // --- State Variables ---
        let imageFiles = []; // Array to hold selected File objects (from user)
        let imageUrls = []; // Array to hold Object URLs for the user images
        let currentImageIndex = 0;
        let slideshowInterval;
        let displayDuration = 5000; // Default duration in milliseconds
        let menuTimeout; // Timeout for hiding the menu
        let usingSampleImages = true; // Flag to track if using samples or user files
        let preloadedImages = {}; // Cache for preloaded images

        // --- Utility Functions ---
        function showMessage(message, duration = 3000) {
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, duration);
        }

        // Preload images for smoother transitions
        function preloadImages(startIndex, count = 3) {
            const imageList = usingSampleImages ? sampleImages : imageUrls;
            if (imageList.length === 0) return;

            for (let i = 0; i < count; i++) {
                const index = (startIndex + i) % imageList.length;
                const imageUrl = usingSampleImages ? imageList[index].url : imageList[index];

                // Skip if already preloaded
                if (preloadedImages[imageUrl]) continue;

                // Create new image for preloading
                const img = new Image();
                img.onload = () => {
                    preloadedImages[imageUrl] = true;
                    console.log(`Preloaded image: ${imageUrl}`);
                };
                img.onerror = () => {
                    console.error(`Failed to preload image: ${imageUrl}`);
                };
                img.src = imageUrl;
            }
        }

        // --- Event Listeners ---

        // Handle file selection
        fileInput.addEventListener('change', (event) => {
            // Revoke previous object URLs if they exist (from previous user selection)
            imageUrls.forEach(url => URL.revokeObjectURL(url));

            imageFiles = Array.from(event.target.files);

            if (imageFiles.length > 0) {
                usingSampleImages = false; // Switch to user files
                imageUrls = imageFiles.map(file => URL.createObjectURL(file)); // Create URLs
                startButton.disabled = false;
                startButton.textContent = `Start Screensaver (${imageFiles.length} photos)`;
                showMessage(`${imageFiles.length} photo(s) selected. Sample images will be replaced.`);
                currentImageIndex = 0; // Reset index for new files
                // No longer display image here, wait for fullscreen start
            } else {
                // If user clears selection, revert to sample images
                usingSampleImages = true;
                imageUrls = []; // Clear user URLs
                imageFiles = []; // Clear user files
                startButton.disabled = false; // Enable button for sample images
                startButton.textContent = `Start Screensaver (${sampleImages.length} sample photos)`;
                showMessage("File selection cleared. Using sample images.");
                currentImageIndex = 0;
                // No longer display image here
                 imageDisplay.src = ""; // Clear image display outside fullscreen
                 imageInfo.textContent = "";
            }
        });

        // Handle duration change
        durationInput.addEventListener('change', () => {
            const seconds = parseInt(durationInput.value, 10);
            if (seconds >= 1) {
                displayDuration = seconds * 1000;
                 // If slideshow is running, restart it with the new duration
                if (slideshowInterval) {
                    stopSlideshow();
                    startSlideshow();
                }
            } else {
                durationInput.value = displayDuration / 1000; // Reset to previous valid value
                showMessage("Duration must be at least 1 second.", 4000);
            }
        });

         // Handle background color change
        bgColorInput.addEventListener('input', (event) => {
             const color = event.target.value;
             fullscreenContainer.style.setProperty('--bg-color', color);
        });

        // Handle Start Button click
        startButton.addEventListener('click', () => {
            const imageList = usingSampleImages ? sampleImages : imageUrls;
            if (imageList.length > 0) {
                requestFullscreen(); // Attempt to go fullscreen
            } else {
                 showMessage("No images available to display.", 4000);
            }
        });

        // Handle Exit Button click
        exitButton.addEventListener('click', () => {
            exitFullscreen();
        });

        // Handle Restart Button click
        restartButton.addEventListener('click', () => {
            currentImageIndex = 0;
            stopSlideshow(); // Stop current cycle
            const imageList = usingSampleImages ? sampleImages : imageUrls;
            if (imageList.length > 0) {
                displayImage(currentImageIndex); // Show first image immediately (already in fullscreen)
                startSlideshow(); // Start new cycle
            }
            hideMenu(); // Hide menu after action
        });

        // Handle fullscreen change events (browser exit, e.g., Esc key)
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange); // Safari

        // Add keyboard controls for accessibility
        document.addEventListener('keydown', (event) => {
            // Only handle keyboard events when in fullscreen
            if (document.fullscreenElement || document.webkitFullscreenElement) {
                switch(event.key) {
                    case 'ArrowRight':
                    case ' ': // Space bar
                        nextImage();
                        break;
                    case 'ArrowLeft':
                        previousImage();
                        break;
                    case 'Escape': // Already handled by browser for exiting fullscreen
                        break;
                    case 'm':
                    case 'M':
                        // Toggle menu
                        if (cornerMenu.style.display === 'block') {
                            hideMenu();
                        } else {
                            showMenu();
                        }
                        break;
                }
            }
        });

        // Handle mouse entering corner zones (only in fullscreen)
        cornerZones.forEach(zone => {
            zone.addEventListener('mouseenter', () => {
                if (document.fullscreenElement || document.webkitFullscreenElement) {
                    showMenu();
                }
            });
        });

        // Handle mouse leaving the menu itself
        cornerMenu.addEventListener('mouseleave', () => {
             hideMenu();
        });

        // --- Core Logic ---

        function displayImage(index) {
            const imageList = usingSampleImages ? sampleImages : imageUrls;
            const fileList = usingSampleImages ? sampleImages : imageFiles;

            if (index >= 0 && index < imageList.length) {
                const imageUrl = usingSampleImages ? imageList[index].url : imageList[index];
                const imageName = usingSampleImages ? fileList[index].name : fileList[index].name;

                // Show loading indicator
                loadingIndicator.style.display = 'block';

                // First fade out the current image
                imageDisplay.classList.add('fade-out');
                imageDisplay.classList.remove('fade-in');

                // Create and preload the next image
                const nextImage = new Image();
                nextImage.onload = () => {
                    // Hide loading indicator once image is loaded
                    loadingIndicator.style.display = 'none';

                    // After the fade-out is complete, update the image and fade it back in
                    setTimeout(() => {
                        // Update the image source and info
                        imageDisplay.src = imageUrl;
                        imageDisplay.alt = imageName;
                        imageInfo.textContent = imageName;

                        // Calculate optimal size for the image based on its natural dimensions
                        // This will be handled by CSS now with our improved layout

                        // Fade the image back in
                        imageDisplay.classList.remove('fade-out');
                        imageDisplay.classList.add('fade-in');
                    }, 250); // Half the transition time for a smoother experience
                };

                nextImage.onerror = () => {
                    // Hide loading indicator on error
                    loadingIndicator.style.display = 'none';

                    console.error("Error loading image:", imageUrl);
                    const fallbackUrl = `https://placehold.co/600x400/${bgColorInput.value.substring(1)}/ffffff?text=Error+Loading+Image`;

                    // After the fade-out is complete, update with error image
                    setTimeout(() => {
                        imageDisplay.src = fallbackUrl;
                        imageInfo.textContent = `Error loading: ${imageName}`;

                        // Fade the image back in
                        imageDisplay.classList.remove('fade-out');
                        imageDisplay.classList.add('fade-in');
                    }, 250);
                };

                nextImage.src = imageUrl;

            } else if (imageList.length === 0) {
                // Hide loading indicator
                loadingIndicator.style.display = 'none';

                // Fade out current image
                imageDisplay.classList.add('fade-out');
                imageDisplay.classList.remove('fade-in');

                setTimeout(() => {
                    const fallbackUrl = `https://placehold.co/800x600/${bgColorInput.value.substring(1)}/ffffff?text=No+Images+Available`;
                    imageDisplay.src = fallbackUrl;
                    imageInfo.textContent = '';

                    // Fade the image back in
                    imageDisplay.classList.remove('fade-out');
                    imageDisplay.classList.add('fade-in');
                }, 250);
            }
        }


        function nextImage() {
            const imageList = usingSampleImages ? sampleImages : imageUrls;
            if (imageList.length === 0) return; // Do nothing if no images

            currentImageIndex = (currentImageIndex + 1) % imageList.length; // Loop back to 0
            displayImage(currentImageIndex);

            // Preload the next few images
            preloadImages(currentImageIndex + 1, 3);

            // Reset the slideshow timer to prevent immediate transition
            resetSlideshowTimer();
        }

        function previousImage() {
            const imageList = usingSampleImages ? sampleImages : imageUrls;
            if (imageList.length === 0) return; // Do nothing if no images

            // Go to previous image, loop to end if at first image
            currentImageIndex = (currentImageIndex - 1 + imageList.length) % imageList.length;
            displayImage(currentImageIndex);

            // Preload the previous few images (in case user keeps going back)
            preloadImages(currentImageIndex - 1 + imageList.length, 2);

            // Reset the slideshow timer to prevent immediate transition
            resetSlideshowTimer();
        }

        // Function to reset the slideshow timer with a delay
        function resetSlideshowTimer() {
            // Only reset if slideshow is active
            if (slideshowInterval) {
                // Stop the current slideshow
                stopSlideshow();

                // Wait for the transition to complete before starting a new slideshow
                // This ensures no double-transitions occur
                setTimeout(() => {
                    startSlideshow();
                }, 600); // Slightly longer than the transition duration (500ms)
            }
        }

        function startSlideshow() {
            // Clear any existing interval first
            stopSlideshow();
            const imageList = usingSampleImages ? sampleImages : imageUrls;
            // Only start interval if more than one image
            if (imageList.length > 1) {
                 slideshowInterval = setInterval(nextImage, displayDuration);
            } else if (imageList.length === 1) {
                 // If only one image, make sure it's displayed (already handled by handleFullscreenChange)
                 // No interval needed
            }
        }


        function stopSlideshow() {
            clearInterval(slideshowInterval);
            slideshowInterval = null;
        }

        function requestFullscreen() {
            // Update duration from input just before starting
            displayDuration = parseInt(durationInput.value, 10) * 1000;
            if (isNaN(displayDuration) || displayDuration < 1000) {
                displayDuration = 5000; // Fallback
                durationInput.value = 5;
            }
             // Update background color
             fullscreenContainer.style.setProperty('--bg-color', bgColorInput.value);

            // Request fullscreen on the container
            console.log("Requesting fullscreen..."); // Debug log
            if (fullscreenContainer.requestFullscreen) {
                fullscreenContainer.requestFullscreen().catch(err => {
                     console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                     showMessage(`Could not enter fullscreen: ${err.message}`, 5000);
                });
            } else if (fullscreenContainer.webkitRequestFullscreen) { /* Safari */
                fullscreenContainer.webkitRequestFullscreen(); // Note: Safari might not return a promise or support catch easily
            } else if (fullscreenContainer.msRequestFullscreen) { /* IE11 */
                fullscreenContainer.msRequestFullscreen();
            } else {
                console.error("Fullscreen API is not supported by this browser.");
                showMessage("Fullscreen is not supported by your browser.", 5000);
            }
        }

        function exitFullscreen() {
             console.log("Exiting fullscreen..."); // Debug log
            if (document.exitFullscreen) {
                document.exitFullscreen().catch(err => console.error("Error exiting fullscreen:", err));
            } else if (document.webkitExitFullscreen) { /* Safari */
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) { /* IE11 */
                document.msExitFullscreen();
            }
        }

        function handleFullscreenChange() {
            const isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement);
            console.log("Fullscreen change detected. Is fullscreen:", isFullscreen); // Debug log
            if (isFullscreen) {
                // Entered fullscreen
                currentImageIndex = 0; // Start from the first image

                // Preload the first few images
                preloadImages(currentImageIndex, 5);

                // Display the first image immediately
                displayImage(currentImageIndex); // Display immediately based on current mode (sample/user)

                // Start the slideshow
                startSlideshow();
                hideMenu(); // Ensure menu is hidden initially
            } else {
                // Exited fullscreen
                stopSlideshow();
                hideMenu(); // Ensure menu is hidden
                // Clear the preloaded images cache when exiting
                preloadedImages = {};
            }
        }

        function showMenu() {
            clearTimeout(menuTimeout); // Clear any pending hide timeout
            cornerMenu.style.display = 'block';
        }

        function hideMenu() {
             // Hide slightly delayed to allow moving mouse from zone to menu
             menuTimeout = setTimeout(() => {
                cornerMenu.style.display = 'none';
             }, 300); // 300ms delay
        }

        // Prevent mouse leaving menu from immediately hiding if re-entering quickly
        cornerMenu.addEventListener('mouseenter', () => {
            clearTimeout(menuTimeout);
        });


        // --- Initial Setup ---
        function initializeApp() {
            // Set initial background color variable
            bgColorInput.dispatchEvent(new Event('input'));

            // Set initial state based on sample images
            usingSampleImages = true;
            currentImageIndex = 0;
            if (sampleImages.length > 0) {
                startButton.disabled = false;
                startButton.textContent = `Start Screensaver (${sampleImages.length} sample photos)`;
                // DO NOT display image here initially
                imageDisplay.src = ""; // Ensure image is blank initially outside fullscreen
                imageInfo.textContent = "";
            } else {
                // Handle case where sampleImages array might be empty
                startButton.disabled = true;
                startButton.textContent = 'No Sample Images Available';
                 imageDisplay.src = ""; // Ensure blank
                 imageInfo.textContent = "";
            }
        }

        // Run initialization when the DOM is ready
        document.addEventListener('DOMContentLoaded', initializeApp);


    </script>

</body>
</html>
